(function(){(this||window).webpackJsonp.registerAbsMids({"esri/tasks/operations/PBFWorker":1576,"esri/tasks/operations/query":1577,"esri/geometry/support/normalizeUtils":1635,"esri/tasks/geometry/cut":1636,"esri/tasks/geometry/simplify":1637,"esri/tasks/operations/pbfQueryUtils":1638,"esri/tasks/operations/urlUtils":1639,"esri/tasks/operations/pbfFeatureServiceParser":1642,"esri/tasks/operations/pbfDehydratedFeatureSet":1643,"esri/tasks/operations/pbfOptimizedFeatureSet":1644,"esri/layers/support/FeatureProcessing":1767,"esri/layers/graphics/data/executeTileQuery":1831,"esri/views/2d/layers/features/support/TileUpdateQueue":1833,"esri/views/2d/layers/features/controllers/OnDemandController":2534,"esri/views/2d/layers/features/support/DataTile":2536,"esri/views/2d/layers/features/support/DataTileFeaturesIndex":2537,"esri/core/SetPool":2538,"esri/views/support/OrderedQueueProcessor":2539})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[51,63,81],{1576:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(3),r(97),r(7),r(407),r(405),r(40),r(633),r(1638),r.dj.m(e)],void 0===(n=function(e,t,r,i,n,s,o,a,u,l,c){Object.defineProperty(t,"__esModule",{value:!0});var p=function(){function e(){}return e.prototype._parseFeatureQuery=function(e){var t=l.parsePBFFeatureQuery(e.buffer,e.options);if(e.options&&"dehydrated"===e.options.type){var r=t;if(t.spatialReference=r.spatialReference.toJSON(),r.fields)for(var i=0;i<r.fields.length;i++)r.fields[i]=r.fields[i].toJSON()}return n.resolve(t)},e}(),d=function(t){function p(){var r=t.call(this)||this;return r._thread=void 0,o.open(s.getAbsMid("./PBFWorker",e,c),{strategy:"dedicated"}).then(function(e){void 0===r._thread?r._thread=e:e.close()}),r}return r(p,t),p.prototype.destroy=function(){this._thread&&this._thread.close(),this._thread=null},p.prototype.parseFeatureQuery=function(e,t){return e&&0!==e.byteLength?this._thread?this._thread.invoke("_parseFeatureQuery",{buffer:e,options:t},{transferList:[e]}).then(function(e){if(t&&"dehydrated"===t.type){var r=e;if(r.spatialReference=a.fromJSON(r.spatialReference),r.fields)for(var n=0;n<r.fields.length;n++)r.fields[n]=u.fromJSON(r.fields[n]);for(var s=r.spatialReference,o=0,l=r.features;o<l.length;o++){var c=l[o];c.uid=i.generateUID(),c.geometry&&(c.geometry.spatialReference=s)}}return e}):n.resolve(l.parsePBFFeatureQuery(e,t)):n.resolve(null)},p}(p);t.PBFWorker=d,t.default=function(){return new p}}.apply(null,i))||(e.exports=n)},1577:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(44),r(58),r(9),r(31),r(57),r(1635),r(1638),r(1576),r(1639),r(105)],void 0===(n=function(e,t,r,i,n,s,o,a,u,l,c,p){function d(e,t){var r=e.geometry,i=e.toJSON(),n=i;if(r&&(n.geometry=JSON.stringify(r),n.geometryType=a.getJsonType(r),n.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference)),i.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=i.groupByFieldsForStatistics.join(",")),i.objectIds&&(n.objectIds=i.objectIds.join(",")),i.orderByFields&&(n.orderByFields=i.orderByFields.join(",")),!i.outFields||t&&(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)?delete n.outFields:-1!==i.outFields.indexOf("*")?n.outFields="*":n.outFields=i.outFields.join(","),i.outSR?n.outSR=i.outSR.wkid||JSON.stringify(i.outSR):r&&(i.returnGeometry||i.returnCentroid)&&(n.outSR=n.inSR),i.returnGeometry&&delete i.returnGeometry,i.outStatistics&&(n.outStatistics=JSON.stringify(i.outStatistics)),i.pixelSize&&(n.pixelSize=JSON.stringify(i.pixelSize)),i.quantizationParameters&&(n.quantizationParameters=JSON.stringify(i.quantizationParameters)),i.source&&(n.layer=JSON.stringify({source:i.source}),delete i.source),i.timeExtent){var s=i.timeExtent,o=s.start,u=s.end;null==o&&null==u||(n.time=o===u?o:(null==o?"null":o)+","+(null==u?"null":u)),delete i.timeExtent}return n}function h(e,t,a,l,c){void 0===l&&(l={});var h="string"==typeof e?o.urlToObject(e):e,f=t.geometry?[t.geometry]:[];return l.responseType="pbf"===a?"array-buffer":"json",n.safeCast(u.normalizeCentralMeridian(f,null,l)).then(function(e){var n=e&&e[0];s.isSome(n)&&((t=t.clone()).geometry=n);var o=p.mapParameters(r({},h.query,{f:a},c,d(t,c)));return i(h.path+"/query",r({},l,{query:o}))})}Object.defineProperty(t,"__esModule",{value:!0});var f,y="Layer does not support extent calculation.";t.queryToQueryStringParameters=d,t.executeQuery=function(e,t,r){return h(e,t,"json",r)},t.executeQueryPBF=function(e,t,r,i){return h(e,t,"pbf",i).then(function(e){var t=function(t){var r=e;return r.data=t,r};return r.useWorker?(null==f&&(f=new c.PBFWorker),f).parseFeatureQuery(e.data,r).then(function(e){return t(e)}):t(l.parsePBFFeatureQuery(e.data,r))})},t.executeQueryForIds=function(e,t,r){return h(e,t,"json",r,{returnIdsOnly:!0})},t.executeQueryForCount=function(e,t,r){return h(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})},t.executeQueryForExtent=function(e,t,r){return h(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then(function(e){var t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(y);if(t.hasOwnProperty("count"))throw new Error(y);return e})}}.apply(null,i))||(e.exports=n)},1635:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(10),r(11),r(98),r(14),r(6),r(9),r(7),r(91),r(104),r(40),r(90),r(63),r(1636),r(1637)],void 0===(n=function(e,t,r,i,n,s,o,a,u,l,c,p,d,h,f,y){function g(e){return"polygon"===e.type}function v(e){return"polygon"===e[0].type}function m(e){return"polyline"===e[0].type}function _(e){return g(e)?e.rings:e.paths}function b(e,t){return Math.ceil((e-t)/(2*t))}function T(e,t){for(var r=0,i=_(e);r<i.length;r++)for(var n=0,s=i[r];n<s.length;n++){s[n][0]+=t}return e}function x(e){for(var t=[],r=0,i=0,n=0;n<e.length;n++){for(var s=e[n],o=null,a=0;a<s.length;a++)o=s[a],t.push(o),0===a?i=r=o[0]:(r=Math.min(r,o[0]),i=Math.max(i,o[0]));o&&t.push([(r+i)/2,0])}return t}function I(e,t){if(!(e instanceof c||e instanceof l)){var r="straightLineDensify: the input geometry is neither polyline nor polygon";throw P.error(r),new s(r)}for(var i=[],n=0,o=_(e);n<o.length;n++){var a=o[n],u=[];i.push(u),u.push([a[0][0],a[0][1]]);for(var p=0;p<a.length-1;p++){var d=a[p][0],h=a[p][1],f=a[p+1][0],y=a[p+1][1],v=Math.sqrt((f-d)*(f-d)+(y-h)*(y-h)),m=(y-h)/v,b=(f-d)/v,T=v/t;if(T>1){for(var x=1;x<=T-1;x++){var I=x*t,F=b*I+d,S=m*I+h;u.push([F,S])}var w=(v+Math.floor(T-1)*t)/2,k=b*w+d,q=m*w+h;u.push([k,q])}u.push([f,y])}}return g(e)?new l({rings:i,spatialReference:e.spatialReference}):new c({paths:i,spatialReference:e.spatialReference})}function F(e,t,r){if(t){var i=I(e,1e6);e=h.webMercatorToGeographic(i,!0)}return r&&(e=T(e,r)),e}function S(e,t,r){var i;if(Array.isArray(e)){if((i=e[0])>t){var n=b(i,t);e[0]=i+n*(-2*t)}else if(i<r){n=b(i,r);e[0]=i+n*(-2*r)}}else if((i=e.x)>t){n=b(i,t);e=e.clone().offset(n*(-2*t),0)}else if(i<r){n=b(i,r);e=e.clone().offset(n*(-2*r),0)}return e}function w(e,t){for(var r=-1,i=0;i<t.cutIndexes.length;i++)!function(i){for(var n=t.cutIndexes[i],s=t.geometries[i],o=_(s),a=0;a<o.length;a++)!function(e){var t=o[e];t.some(function(r){if(r[0]<180)return!0;for(var i=0,n=0;n<t.length;n++){var o=t[n][0];i=o>i?o:i}for(var a=-360*b(i=Number(i.toFixed(9)),180),u=0;u<t.length;u++){var l=s.getPoint(e,u);s.setPoint(e,u,l.clone().offset(a,0))}return!0})}(a);if(n===r){if(v(e))for(var u=0,l=_(s);u<l.length;u++){var c=l[u];e[n]=e[n].addRing(c)}else if(m(e))for(var p=0,d=_(s);p<d.length;p++){var h=d[p];e[n]=e[n].addPath(h)}}else r=n,e[n]=s}(i);return e}Object.defineProperty(t,"__esModule",{value:!0});var P=o.getLogger("esri.geometry.support.normalizeUtils"),k={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new c({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:p.WebMercator}),minus180Line:new c({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:p.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new c({paths:[[[180,-180],[180,180]]],spatialReference:p.WGS84}),minus180Line:new c({paths:[[[-180,-180],[-180,180]]],spatialReference:p.WGS84})}};t.straightLineDensify=I,t.normalizeCentralMeridian=function e(t,s,o){return i(this,void 0,void 0,function(){var i,p,g,v,m,_,x,I,P,q,C,j,O,M,E,Q,B,R,N,D,G,A,L,J,z,U,V,W,H,Z,X,Y,K,$,ee,te,re;return r(this,function(r){switch(r.label){case 0:if(!Array.isArray(t))return[2,e([t],s)];for(i=s?s.url:n.geometryServiceUrl,q=0,C=[],j=[],O=0,M=t;O<M.length;O++)E=M[O],a.isNone(E)?j.push(E):(p||(p=E.spatialReference,g=d.getInfo(p),v=p.isWebMercator,m=k[x=v?102100:4326].maxX,_=k[x].minX,I=k[x].plus180Line,P=k[x].minus180Line),g?"mesh"===E.type?j.push(E):"point"===E.type?j.push(S(E.clone(),m,_)):"multipoint"===E.type?((Q=E.clone()).points=Q.points.map(function(e){return S(e,m,_)}),j.push(Q)):"extent"===E.type?(R=E.clone(),B=R._normalize(!1,!1,g),j.push(B.rings?new l(B):B)):E.extent?(R=E.extent,N=b(R.xmin,_),G=0==(D=N*(2*m))?E.clone():T(E.clone(),D),R.offset(D,0),R.intersects(I)&&R.xmax!==m?(q=R.xmax>q?R.xmax:q,G=F(G,v),C.push(G),j.push("cut")):R.intersects(P)&&R.xmin!==_?(q=R.xmax*(2*m)>q?R.xmax*(2*m):q,G=F(G,v,360),C.push(G),j.push("cut")):j.push(G)):j.push(E.clone()):j.push(E));for(A=b(q,m),L=-90,J=A,z=new c;A>0;)U=360*A-180,z.addPath([[U,L],[U,-1*L]]),L*=-1,A--;return C.length>0&&J>0?[4,f.cut(i,C,z,o)]:[3,3];case 1:for(V=r.sent(),W=w(C,V),H=[],Z=[],ee=0;ee<j.length;ee++)"cut"!==(te=j[ee])?Z.push(te):(re=W.shift(),X=t[ee],a.isSome(X)&&"polygon"===X.type&&X.rings&&X.rings.length>1&&re.rings.length>=X.rings.length?(H.push(re),Z.push("simplify")):Z.push(v?h.geographicToWebMercator(re):re));return H.length?[4,y.simplify(i,H,o)]:[2,Z];case 2:for(Y=r.sent(),K=[],ee=0;ee<Z.length;ee++)"simplify"!==(te=Z[ee])?K.push(te):K.push(v?h.geographicToWebMercator(Y.shift()):Y.shift());return[2,K];case 3:for($=[],ee=0;ee<j.length;ee++)"cut"!==(te=j[ee])?$.push(te):(re=C.shift(),$.push(!0===v?h.geographicToWebMercator(re):re));return[2,u.resolve($)]}})})},t.getDenormalizedExtent=function(e){var t;if(!e)return null;var r=e.extent;if(!r)return null;var i=e.spatialReference&&d.getInfo(e.spatialReference);if(!i)return r;var n,s=i.valid,o=s[0],a=s[1],u=2*a,l=r.width,c=r.xmin,p=r.xmax;if(c=(t=[p,c])[0],p=t[1],"extent"===e.type||0===l||l<=a||l>u||c<o||p>a)return r;switch(e.type){case"polygon":if(!(e.rings.length>1))return r;n=x(e.rings);break;case"polyline":if(!(e.paths.length>1))return r;n=x(e.paths);break;case"multipoint":n=e.points}for(var h=r.clone(),f=0;f<n.length;f++){var y=n[f][0];y<0?(y+=a,p=Math.max(y,p)):(y-=a,c=Math.min(y,c))}return h.xmin=c,h.xmax=p,h.width<l?(h.xmin-=a,h.xmax-=a,h):r},t.normalizeMapX=function(e,t){var r=d.getInfo(t);if(r){var i=r.valid,n=i[0],s=i[1],o=s-n;if(e<n)for(;e<n;)e+=o;if(e>s)for(;e>s;)e-=o}return e}}.apply(null,i))||(e.exports=n)},1636:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(11),r(10),r(36),r(44),r(31),r(57)],void 0===(n=function(e,t,r,i,n,s,o,a,u){Object.defineProperty(t,"__esModule",{value:!0}),t.cut=function(e,t,l,c){return i(this,void 0,void 0,function(){var i,p,d,h,f,y,g;return n(this,function(n){switch(n.label){case 0:return i="string"==typeof e?a.urlToObject(e):e,p=t[0].spatialReference,d=r({},c,{query:r({},i.query,{f:"json",sr:JSON.stringify(p),target:JSON.stringify({geometryType:u.getJsonType(t[0]),geometries:t}),cutter:JSON.stringify(l)})}),[4,o(i.path+"/cut",d)];case 1:return h=n.sent(),f=h.data,y=f.cutIndexes,g=f.geometries,[2,{cutIndexes:y,geometries:(void 0===g?[]:g).map(function(e){return s.fromJSON(e).set(p)})}]}})})}}.apply(null,i))||(e.exports=n)},1637:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(11),r(10),r(44),r(31),r(57)],void 0===(n=function(e,t,r,i,n,s,o,a){Object.defineProperty(t,"__esModule",{value:!0}),t.simplify=function(e,t,u){return i(this,void 0,void 0,function(){var i,l,c,p;return n(this,function(n){switch(n.label){case 0:return i="string"==typeof e?o.urlToObject(e):e,l=t[0].spatialReference,c=a.getJsonType(t[0]),p=r({},u,{query:r({},i.query,{f:"json",sr:l.wkid?l.wkid:JSON.stringify(l),geometries:JSON.stringify(function(e){return{geometryType:a.getJsonType(e[0]),geometries:e.map(function(e){return e.toJSON()})}}(t))})}),[4,s(i.path+"/simplify",p)];case 1:return[2,function(e,t,r){var i=a.getGeometryType(t);return e.map(function(e){var t=i.fromJSON(e);return t.spatialReference=r,t})}(n.sent().data,c,l)]}})})}}.apply(null,i))||(e.exports=n)},1638:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1642)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.parsePBFFeatureQuery=function(e,t){var i=r.parseFeatureQuery(e,t).queryResult.featureResult;if(i&&i.features&&i.features.length&&i.objectIdFieldName)for(var n=i.objectIdFieldName,s=0,o=i.features;s<o.length;s++){var a=o[s];a.attributes&&(a.objectId=a.attributes[n])}return i}}.apply(null,i))||(e.exports=n)},1639:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mapParameters=function e(t){var r={};for(var i in t)if("declaredClass"!==i){var n=t[i];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){r[i]=[];for(var s=0;s<n.length;s++)r[i][s]=e(n[s])}else"object"==typeof n?n.toJSON&&(r[i]=JSON.stringify(n)):r[i]=n}return r}}.apply(null,i))||(e.exports=n)},1642:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(14),r(6),r(639),r(1643),r(1644)],void 0===(n=function(e,t,r,i,n,s,o){function a(e){return e>=S.length?null:S[e]}function u(e){return e>=w.length?null:w[e]}function l(e){return e>=P.length?null:P[e]}function c(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function p(e,t,r){for(var i=t.createPointGeometry(r);e.next();)switch(e.tag()){case 3:for(var n=e.getUInt32(),s=e.pos()+n,o=0;e.pos()<s;)t.addCoordinatePoint(i,e.getSInt64(),0,o++);break;case 1:case 2:default:e.skip()}return i}function d(e,t,r){for(var i=t.createGeometry(r),n=2+(r.hasZ?1:0)+(r.hasM?1:0);e.next();)switch(e.tag()){case 2:for(var s=e.getUInt32(),o=e.pos()+s,a=0;e.pos()<o;)t.addLength(i,e.getUInt32(),a++);break;case 3:for(var u=e.getUInt32(),l=(o=e.pos()+u,0),c=0;e.pos()<o;)t.addCoordinate(i,e.getSInt64(),c,l),++l===n&&(c++,l=0);break;case 1:default:e.skip()}return i}function h(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function f(e){for(var t={type:a(0)};e.next();)switch(e.tag()){case 1:t.name=e.getString();break;case 2:t.type=a(e.getEnum());break;case 3:t.alias=e.getString();break;case 4:t.sqlType=u(e.getEnum());break;case 5:case 6:default:e.skip()}return t}function y(e,t,r,i){for(var n=t.createFeature(r),s=0;e.next();)switch(e.tag()){case 1:var o=i[s++].name;n.attributes[o]=e.processMessage(h);break;case 2:n.geometry=e.processMessageWithArgs(d,t,r);break;case 4:n.centroid=e.processMessageWithArgs(p,t,r);break;default:e.skip()}return n}function g(e){for(var t=[0,0,0,0];e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function v(e){for(var t=[0,0,0,0];e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function m(e){for(var t={originPosition:l(0)};e.next();)switch(e.tag()){case 1:t.originPosition=l(e.getEnum());break;case 2:t.scale=e.processMessage(g);break;case 3:t.translate=e.processMessage(v);break;default:e.skip()}return t}function _(e){for(var t={};e.next();)switch(e.tag()){case 1:t.shapeAreaFieldName=e.getString();break;case 2:t.shapeLengthFieldName=e.getString();break;case 3:t.units=e.getString();break;default:e.skip()}return t}function b(e,t){for(var r=t.createSpatialReference();e.next();)switch(e.tag()){case 1:r.wkid=e.getUInt32();break;case 5:r.wkt=e.getString();break;case 2:case 3:case 4:default:e.skip()}return r}function T(e,t){var r=t.createFeatureResult();r.geometryType=c(t,0);for(var i=!1;e.next();)switch(e.tag()){case 1:r.objectIdFieldName=e.getString();break;case 3:r.globalIdFieldName=e.getString();break;case 4:r.geohashFieldName=e.getString();break;case 5:r.geometryProperties=e.processMessage(_);break;case 7:r.geometryType=c(t,e.getEnum());break;case 8:r.spatialReference=e.processMessageWithArgs(b,t);break;case 10:r.hasZ=e.getBool();break;case 11:r.hasM=e.getBool();break;case 12:r.transform=e.processMessage(m);break;case 9:var n=e.getBool();r.exceededTransferLimit=n;break;case 13:t.addField(r,e.processMessage(f));break;case 15:i||(t.prepareFeatures(r),i=!0),t.addFeature(r,e.processMessageWithArgs(y,t,r,r.fields));break;case 2:case 6:default:e.skip()}return t.finishFeatureResult(r),r}function x(e,t){for(var r={};e.next();)switch(e.tag()){case 1:r.featureResult=e.processMessageWithArgs(T,t);break;default:e.skip()}return r}function I(e){return e&&"dehydrated"===e.type?new s.Context(e):new o.Context(e)}Object.defineProperty(t,"__esModule",{value:!0});var F=i.getLogger("esri.tasks.operations.pbfFeatureServiceParser"),S=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],w=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],P=["upperLeft","lowerLeft"];t.parseFeatureQuery=function(e,t){var i=I(t);try{for(var s=new n(new Uint8Array(e),new DataView(e)),o={};s.next();)switch(s.tag()){case 2:o.queryResult=s.processMessageWithArgs(x,i);break;default:s.skip()}return o}catch(e){var a=new r("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});return F.error(a),{queryResult:{featureResult:i.createFeatureResult()}}}}}.apply(null,i))||(e.exports=n)},1643:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(97),r(24),r(40),r(103),r(633)],void 0===(n=function(e,t,r,i,n,s,o){function a(e,t,r,i){return t}function u(e,t,r,i){switch(r){case 0:return d(e,t+i,0);case 1:return h(e,t+i,1)}}function l(e,t,r,i){switch(r){case 0:return d(e,t+i,0);case 1:return h(e,t+i,1);case 2:return d(e,t,2)}}function c(e,t,r,i){switch(r){case 0:return d(e,t+i,0);case 1:return h(e,t+i,1);case 2:return d(e,t,3)}}function p(e,t,r,i){switch(r){case 0:return d(e,t+i,0);case 1:return h(e,t+i,1);case 2:case 3:return d(e,t,3)}}function d(e,t,r){var i=e.translate,n=e.scale;return i[r]+t*n[r]}function h(e,t,r){var i=e.translate,n=e.scale;return i[r]-t*n[r]}Object.defineProperty(t,"__esModule",{value:!0});var f=function(){function e(e){this.options=e,this.geometryTypes=["point","multipoint","polyline","polygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=a,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this.AttributesConstructor=function(){}}return e.prototype.createFeatureResult=function(){return new s.DehydratedFeatureSetClass},e.prototype.finishFeatureResult=function(e){this.options.applyTransform&&(e.transform=null),this.AttributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0},e.prototype.createSpatialReference=function(){return new n},e.prototype.addField=function(e,t){e.fields.push(o.fromJSON(t));var r=e.fields.map(function(e){return e.name});this.AttributesConstructor=function(){for(var e=0,t=r;e<t.length;e++)this[t[e]]=null}},e.prototype.addFeature=function(e,t){var r=this.options.maxStringAttributeLength?this.options.maxStringAttributeLength:0;if(r>0)for(var i in t.attributes){var n=t.attributes[i];"string"==typeof n&&n.length>r&&(t.attributes[i]="")}e.features.push(t)},e.prototype.prepareFeatures=function(e){switch(this.options.applyTransform&&e.transform&&(this.transform=e.transform,this.applyTransform=this.deriveApplyTransform(e)),this.vertexDimension=2,e.hasZ&&this.vertexDimension++,e.hasM&&this.vertexDimension++,e.geometryType){case"point":this.addCoordinate=this.addCoordinatePoint.bind(this),this.createGeometry=this.createPointGeometry.bind(this);break;case"polygon":this.addCoordinate=this.addCoordinatePolygon.bind(this),this.createGeometry=this.createPolygonGeometry.bind(this);break;case"polyline":this.addCoordinate=this.addCoordinatePolyline.bind(this),this.createGeometry=this.createPolylineGeometry.bind(this);break;case"multipoint":this.addCoordinate=this.addCoordinateMultipoint.bind(this),this.createGeometry=this.createMultipointGeometry.bind(this);break;default:i.neverReached(e.geometryType)}},e.prototype.createFeature=function(e){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,new s.DehydratedFeatureClass(r.generateUID(),null,new this.AttributesConstructor)},e.prototype.addLength=function(e,t,r){0===this.lengths.length&&(this.toAddInCurrentPath=t),this.lengths.push(t)},e.prototype.createPointGeometry=function(e){var t={type:"point",x:0,y:0,spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM};return t.hasZ&&(t.z=0),t.hasM&&(t.m=0),t},e.prototype.addCoordinatePoint=function(e,t,r,i){switch(t=this.applyTransform(this.transform,t,i,0),i){case 0:e.x=t;break;case 1:e.y=t;break;case 2:e.hasZ?e.z=t:e.m=t;break;case 3:e.m=t}},e.prototype.transformPathLikeValue=function(e,t){var r=0;return t<=1&&(r=this.previousCoordinate[t],this.previousCoordinate[t]+=e),this.applyTransform(this.transform,e,t,r)},e.prototype.addCoordinatePolyline=function(e,t,r,i){this.dehydratedAddPointsCoordinate(e.paths,t,r,i)},e.prototype.addCoordinatePolygon=function(e,t,r,i){this.dehydratedAddPointsCoordinate(e.rings,t,r,i)},e.prototype.addCoordinateMultipoint=function(e,t,r){0===r&&e.points.push([]);var i=this.transformPathLikeValue(t,r);e.points[e.points.length-1].push(i)},e.prototype.createPolygonGeometry=function(e){return{type:"polygon",rings:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}},e.prototype.createPolylineGeometry=function(e){return{type:"polyline",paths:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}},e.prototype.createMultipointGeometry=function(e){return{type:"multipoint",points:[],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}},e.prototype.dehydratedAddPointsCoordinate=function(e,t,r,i){if(null===this.coordinateBuffer){var n=this.lengths.reduce(function(e,t){return e+t},0);this.coordinateBuffer=new Float64Array(n*this.vertexDimension)}0===i&&0==this.toAddInCurrentPath--&&(e.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);var s=this.transformPathLikeValue(t,i),o=e[e.length-1];0===i&&o.push(new Float64Array(this.coordinateBuffer.buffer,this.coordinateBufferPtr*Float64Array.BYTES_PER_ELEMENT,this.vertexDimension)),this.coordinateBuffer[this.coordinateBufferPtr++]=s},e.prototype.deriveApplyTransform=function(e){var t=e.hasZ,r=e.hasM;return t&&r?p:t?l:r?c:u},e}();t.Context=f}.apply(null,i))||(e.exports=n)},1644:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(634),r(641),r(404)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e){this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"]}return e.prototype.createFeatureResult=function(){return new i.default},e.prototype.prepareFeatures=function(){},e.prototype.finishFeatureResult=function(){},e.prototype.addFeature=function(e,t){e.features.push(t)},e.prototype.createFeature=function(){return new r.default},e.prototype.createSpatialReference=function(){return{wkid:0}},e.prototype.createGeometry=function(){return new n.default},e.prototype.addField=function(e,t){e.fields.push(t)},e.prototype.addCoordinate=function(e,t){e.coords.push(t)},e.prototype.addCoordinatePoint=function(e,t){e.coords.push(t)},e.prototype.addLength=function(e,t){e.lengths.push(t)},e.prototype.createPointGeometry=function(){return new n.default},e}();t.Context=s}.apply(null,i))||(e.exports=n)},1767:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(16),r(15),r(0),r(633),r(117)],void 0===(n=function(e,t,r,i,n,s,o,a,u){return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}var n;return r(t,e),n=t,t.fromWorker=function(e){if(!e)return null;var t=JSON.parse(e),r=new n;return r.fields=t.fields&&t.fields.map(function(e){return a.fromJSON(e)}),r.options=t.options,r.process=new(Function.bind.apply(Function,[void 0].concat(t.process.args,[t.process.body]))),r},Object.defineProperty(t.prototype,"version",{get:function(){return(this._get("version")||0)+1},enumerable:!0,configurable:!0}),t.prototype.clone=function(){return new n(s.clone({fields:this.fields,options:this.options,process:this.process}))},t.prototype.getField=function(e){return u.getField(this.fields,e)},t.prototype.refresh=function(){this.notifyChange("version")},t.prototype.toWorker=function(){var e=this.process.toString();return JSON.stringify({fields:this.fields,options:this.options,process:{body:e.substring(e.indexOf("{")+1,e.lastIndexOf("}")),args:e.slice(e.indexOf("(")+1,e.indexOf(")")).match(/([^\s,]+)/g)}})},i([o.property({type:[a]})],t.prototype,"fields",void 0),i([o.property()],t.prototype,"options",void 0),i([o.property()],t.prototype,"process",void 0),i([o.property({readOnly:!0,dependsOn:["process","options","fields"]})],t.prototype,"version",null),n=i([o.subclass("esri.layers.support.FeatureProcessing")],t)}(o.declared(n))}.apply(null,i))||(e.exports=n)},1831:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(10),r(11),r(33),r(90),r(1679),r(1686)],void 0===(n=function(e,t,r,i,n,s,o,a,u){function l(e,t,r,i,n,s,o,l){o&&!s?i.forEachInBounds(n,function(i){if(!t.has(i.objectId)){var n=u.getCentroid(r,i,l),s=i.attributes;n&&(t.add(i.objectId),e.push(new a.Feature(s,i.localId,null,n)))}}):s&&!o?i.forEachInBounds(n,function(i){if(!t.has(i.objectId)){var n=i.attributes,s=u.getGeometry(r,i,0,l);s&&(t.add(i.objectId),e.push(new a.Feature(n,i.localId,s,null)))}}):i.forEachInBounds(n,function(i){if(!t.has(i.objectId)){var n=i.attributes,s=u.getGeometry(r,i,0,l),o=u.getCentroid(r,i,l);s&&o&&(t.add(i.objectId),e.push(new a.Feature(n,i.localId,s,o)))}})}Object.defineProperty(t,"__esModule",{value:!0}),t.executeTileQueryForIds=function(e,t,r){var i=r.pixelBuffer*t.resolution,n=s.pad(t.bounds,i,s.create()),o=[];return e.featureStore.forEachInBounds(n,function(t){return o.push(e.featureAdapter.getObjectId(t))}),o},t.executeTileQuery=function(e,t,r){var i=r.returnGeometry,n=r.returnCentroid,a=r.pixelBuffer,u=new Set,c=[],p=a*t.resolution,d=s.pad(t.bounds,p,s.create());if(l(c,u,e,e.featureStore,d,i,n,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]}),"esriGeometryPoint"===e.geometryType||n){var h=o.getInfo(e.spatialReference);if(h){var f=h.valid,y=f[0],g=f[1];if(d[0]<y){var v=s.fromValues(g-p,d[1],g,d[3]);l(c,u,e,e.featureStore,v,i,n,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[g,t.bounds[3]]})}if(d[2]>g){var m=s.fromValues(y,d[1],y+p,d[3]);l(c,u,e,e.featureStore,m,i,n,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[y-g+t.bounds[0],t.bounds[3]]})}}}return c.sort(function(t,r){return t.attributes[e.objectIdField]-r.attributes[e.objectIdField]}),{features:c,objectIds:u}}}.apply(null,i))||(e.exports=n)},1833:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(10),r(11),r(16),r(7),r(52),r(0),r(28),r(667)],void 0===(n=function(e,t,r,i,n,s,o,a,u,l,c,p){Object.defineProperty(t,"__esModule",{value:!0});var d=[0,0],h=function(e){function t(t){var r=e.call(this,t)||this;return r._queue=new Map,r._isPaused=!1,r._scheduledNextHandle=null,r._timestamp=Date.now(),r.tileInfoView=null,r._next=r._next.bind(r),r._finalize=r._finalize.bind(r),r}return r(t,e),Object.defineProperty(t.prototype,"length",{get:function(){return this._queue.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._queue.size>0||null!=this._onGoingTile},enumerable:!0,configurable:!0}),t.prototype.abort=function(e){this._onGoingTile&&this._onGoingTile.tileId===e&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._queue.delete(e),this._scheduleNext(),this.notifyChange("updating")},t.prototype.clear=function(){this._queue.clear(),this._onGoingTile&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._cancelNext(),this.notifyChange("updating")},t.prototype.has=function(e){return this._queue.has(e)},t.prototype.isOngoing=function(e){return this._onGoingTile&&this._onGoingTile.tileId===e},t.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())},t.prototype.push=function(e,t){if(!this._queue.has(e)){var r=a.createAbortController();this._queue.set(e,{tileId:e,key:p.TileKey.pool.acquire(e),timestamp:t||this._timestamp,abortController:r}),this._scheduleNext(),this.notifyChange("updating")}},t.prototype.refresh=function(){this._timestamp=Date.now(),this.reset()},t.prototype.reset=function(){var e=this._onGoingTile;if(e){var t=e.tileId;this.push(t,this._timestamp)}this.notifyChange("updating")},t.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext()),this.notifyChange("updating")},t.prototype._finalize=function(){this._onGoingTile=null,this.notifyChange("updating"),this._scheduleNext()},t.prototype._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)},t.prototype._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=u.schedule(this._next))},t.prototype._next=function(){return s(this,void 0,void 0,function(){var e,t,r,i,s;return n(this,function(n){switch(n.label){case 0:if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)return this._scheduledNextHandle=null,[2];if(this._scheduledNextHandle=null,e=this._peek(),t=e.abortController.signal,r=e.tileId,i=e.key,p.TileKey.pool.release(i),this._queue.delete(r),this._onGoingTile=e,s=this.process(r,this._timestamp,{signal:t}),this.notifyChange("updating"),!function(e){return e&&"function"==typeof e.then}(s))return[3,4];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,s];case 2:return n.sent(),[3,4];case 3:return n.sent(),[3,4];case 4:return this._finalize(),[2]}})})},t.prototype._peek=function(){var e=this;if(!this.state)throw new Error("state not set");var t=this.tileInfoView,r=this.state.center,i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,s=null;return this._queue.forEach(function(o,a){t.getTileCoords(d,o.key);var u=e._timestamp-o.timestamp;if(isNaN(u))(l=c.vec2.distance(d,r))<n&&(n=l,s=o);else if(u===i){var l;(l=c.vec2.distance(d,r))<n&&(n=l,s=o)}else u>i&&(i=u,n=Number.POSITIVE_INFINITY,s=o)}),s},i([l.property({readOnly:!0})],t.prototype,"length",null),i([l.property({constructOnly:!0})],t.prototype,"process",void 0),i([l.property()],t.prototype,"state",void 0),i([l.property({constructOnly:!0})],t.prototype,"tileInfoView",void 0),i([l.property({readOnly:!0})],t.prototype,"updating",null),i([l.subclass("esri.views.2d.layers.features.support.TileUpdateQueue")],t)}(l.declared(o));t.default=h}.apply(null,i))||(e.exports=n)},2534:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(4),r(10),r(11),r(232),r(58),r(14),r(18),r(6),r(7),r(0),r(37),r(227),r(1831),r(1577),r(184),r(1832),r(2536),r(2537),r(1715),r(1833),r(657),r(2539)],void 0===(n=function(e,t,r,i,n,s,o,a,u,l,c,p,d,h,f,y,g,v,m,_,b,T,x,I,F,S){Object.defineProperty(t,"__esModule",{value:!0});var w=p.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),P=c("esri-featurelayer-webgl"),k=c("esri-mobile"),q={maxDrillLevel:P&&"object"==typeof P&&null!=P.maxDrillLevel?P.maxDrillLevel:k?1:4,maxRecordCountFactor:P&&"object"==typeof P&&null!=P.maxRecordCountFactor?P.maxRecordCountFactor:k?1:3,enablePBFQuery:!P||"object"!=typeof P||null==P.enablePBFQuery||P.enablePBFQuery},C=new Set,j=[],O=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._dataTileIndex=new T.default,t._editsQueue=new S.OrderedQueueProcessor({concurrency:1,process:function(e,r){return t._processEditsEvent(e,r)}}),t._featuresInFlight=new Map,t}return r(t,e),t.prototype.initialize=function(){var e=this;this._set("queryEngine",this._createQueryEngine()),this._set("featureStore",this.queryEngine.featureStore),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach(function(e){return e.done=!1}),this._fetchQueue=new F({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t,e.queryInfo,r)}}),this._patchQueue=new F({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t.dataTile,t.queryInfo,r)}}),this._updateQueue=new I.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._updateTile(t,r,i)}})},t.prototype.destroy=function(){this._fetchQueue.clear(),this._patchQueue.clear(),this._updateQueue.clear(),this._editsQueue.destroy(),this.queryEngine.destroy()},Object.defineProperty(t.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return o(this,void 0,void 0,function(){var r,i,n=this;return s(this,function(s){switch(s.label){case 0:return this.validateConfig(e,t),r=this.renderer.getAttributeHash(),i=e.availableFields.filter(function(e){return-1===n.availableFields.indexOf(e)}),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return s.sent(),t?r===this.renderer.getAttributeHash()?[3,3]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,5];case 2:s.sent(),s.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return s.sent(),this.refresh(),[2];case 5:return i.length?[4,this._handleAttributeChange(i)]:[3,7];case 6:s.sent(),s.label=7;case 7:return"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,9]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 8:s.sent(),this.featureStore.forEach(function(e){return n.attributeStore.setAttributeData(e.localId,e,n.geometryInfo,n.viewParams)}),s.label=9;case 9:return[4,this.attributeStore.updateFilters(this)];case 10:return s.sent(),[4,this.attributeStore.sendUpdates()];case 11:return s.sent(),[2]}})})},t.prototype.invalidate=function(){for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._updateQueue.push(r.id,Date.now())}},t.prototype.onEdits=function(e){var t=this;this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then(function(){0===t._editsQueue.length&&t._fetchQueue.resume()})},t.prototype.queryFeatures=function(e){return u.safeCast(this.queryEngine.executeQuery(e))},t.prototype.queryFeatureCount=function(e){return u.safeCast(this.queryEngine.executeQueryForCount(e))},t.prototype.queryObjectIds=function(e){return u.safeCast(this.queryEngine.executeQueryForIds(e))},t.prototype.queryExtent=function(e){return u.safeCast(this.queryEngine.executeQueryForExtent(e))},t.prototype.redraw=function(){this._updateQueue.pause(),this._manageTiles(this.tileStore.tiles),this._updateQueue.resume()},t.prototype.refresh=function(){this._queryInfoHash=Math.random().toString(),this.queryEngine&&this.queryEngine.destroy(),this.featureStore&&this.featureStore.clear(),this._set("queryEngine",this._createQueryEngine()),this._set("featureStore",this.queryEngine.featureStore),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach(function(e){return e.done=!1}),this._editsQueue.pause(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),this._updateQueue.clear(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),this._editsQueue.resume(),this._updateQueue.resume()},t.prototype.setViewState=function(e){var t=this,r=this.viewState&&this.viewState.scale;this.inherited(arguments),this._fetchQueue.state=e,this._updateQueue.state=e,r!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach(function(e){return t.attributeStore.setAttributeData(e.localId,e,t.geometryInfo,t.viewParams)}),this.attributeStore.sendUpdates())},t.prototype.onTileUpdate=function(e){this._manageTiles(e.added,e.removed)},t.prototype.onFeatureAdd=function(e){if(this._featuresInFlight.has(e.objectId)){var t=this._featuresInFlight.get(e.objectId).attributes;e.attributes=n({},t,e.attributes),this._featuresInFlight.delete(e.objectId)}e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype._handleAttributeChange=function(e){return o(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return[4,this._fetchChangedFields(e)];case 1:return t.sent(),[2]}})})},t.prototype._fetchChangedTileFields=function(e,t){return o(this,void 0,void 0,function(){var r;return s(this,function(i){return(r=this._dataTileIndex.get(e.id))?!1?[2,this._fetchChangedTileFieldsPaged(r,t)]:[2,this._fetchChangedTileFieldsDrill(r,t)]:[2]})})},t.prototype._fetchChangedTileFieldsDrill=function(e,t,r){return void 0===r&&(r=0),o(this,void 0,void 0,function(){var i,o,a,u,l,c,p,h,f,y,g=this;return s(this,function(s){switch(s.label){case 0:return i=n({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField])}),e.returnExceeded=e.returnExceeded||r>=q.maxDrillLevel,o=e.key,a={key:o,dataTile:e,queryInfo:i},[4,this._patchQueue.push(a)];case 1:return(u=s.sent()).exceededTransferLimit&&r<q.maxDrillLevel?(l=e.tile.createChildTiles(),c=l.map(function(t){var r=new b.default;return r.tile=t,r.displayTile=e.displayTile,r}),[4,d.all(c.map(function(e){return g._fetchChangedTileFieldsDrill(e,t,r+1)}))]):[3,3];case 2:return s.sent(),[2];case 3:for(p=0,h=u.features;p<h.length;p++)f=h[p],this.featureStore.has(f.objectId)?(y=this.featureStore.getFeature(f.objectId)).attributes=n({},y.attributes,f.attributes):this._featuresInFlight.set(f.objectId,f);return[2]}})})},t.prototype._fetchChangedTileFieldsPaged=function(e,t,r){return void 0===r&&(r=0),o(this,void 0,void 0,function(){var i,o,a,u,l,c,p,d,h,f,y;return s(this,function(s){switch(s.label){case 0:return i=this.service.capabilities.query.supportsMaxRecordCountFactor,o=this.service.tileMaxRecordCount,a=o*(i?1:q.maxRecordCountFactor),u=n({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField]),resultOffset:r*a,num:a}),e.returnExceeded=!0,l=e.key,c={key:l,dataTile:e,queryInfo:u},[4,this._patchQueue.push(c)];case 1:for(p=s.sent(),d=0,h=p.features;d<h.length;d++)f=h[d],this.featureStore.has(f.objectId)?(y=this.featureStore.getFeature(f.objectId)).attributes=n({},y.attributes,f.attributes):this._featuresInFlight.set(f.objectId,f);return p.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(e,t,r+1)]:[2]}})})},t.prototype._fetchChangedFields=function(e){return o(this,void 0,void 0,function(){var t,r,i=this;return s(this,function(n){switch(n.label){case 0:return t=this.tileStore.tiles,r=t.map(function(t){return i._fetchChangedTileFields(t,e)}),[4,d.all(r)];case 1:return n.sent(),[2]}})})},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,n=this._updateQueue,s="esriGeometryPoint"===this.service.geometryType,o=this,a=0,u=e;a<u.length;a++){!function(e){var t=r.get(e.id);t?(t.displayTile=e,s?r.forEach(function(r){x.isChildOf(r,t)&&(r.displayTile=e)}):t.done=!1):((t=new b.default).tile=e.clone(),t.displayTile=e,r.add(t)),o._processDataTile(t)}(p=u[a])}if(t)for(var l=0,c=t;l<c.length;l++){var p=c[l];C.add(p),n.abort(p.id)}r.forEach(function(e){C.has(e.displayTile)&&j.push(e)});for(var d=0,h=j;d<h.length;d++){var f=h[d];i.abort(f.id),r.delete(f)}j.length=0,C.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,n=this._dataTileIndex,s=this._fetchQueue,o=i.id,a=this._queryInfoHash,u=i.level-r.key.level>=q.maxDrillLevel;if(n.add(e),e.done||s.has(o)){if(e.queryInfoHash!==a||e.returnExceeded!==u)if(e.done)e.done=!1;else{if(!s.isOngoing(o))return e.queryInfoHash=a,void(e.returnExceeded=u);s.abort(o)}}else e.queryInfoHash=a,e.returnExceeded=u;e.done?this._invalidateTile(e.displayTile):s.has(o)||s.push(e).then(function(r){return t._handleResponse(e,r)}).catch(function(r){d.isAbortError(r)||w.error(new l("featurelayer-controller:tile-error","Encountered an error when handling tile response",r)),e.done=!0,t._invalidateTile(e.displayTile)})},t.prototype._handleResponse=function(e,t){if(e.done=!0,y.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else{for(var r=e.tile.createChildTiles(),i=0,n=r;i<n.length;i++){var s=n[i],o=new b.default;o.tile=s,o.displayTile=e.displayTile,this._processDataTile(o)}a.release(r)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile),this.attributeStore.sendUpdates()},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach(function(t){x.isChildOf(t,e)&&j.push(t)});for(var t=0,r=j;t<r.length;t++){var i=r[t];this._fetchQueue.abort(i.id),this._dataTileIndex.delete(i)}j.length=0},t.prototype._fetchTile=function(e,t,r){return o(this,void 0,void 0,function(){var i,n,o,a,u,l,c,p,d,h=this;return s(this,function(s){return i=new f({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference}),n="esriGeometryPoint"===this.service.geometryType?e.tile:e.displayTile,o=n.extent,a=n.resolution,u=e.returnExceeded,l=this._createQuery(i,o,a,t,q.maxRecordCountFactor,u),c=this.service.source,p=q.enablePBFQuery&&this.service.capabilities.query.supportsFormatPBF,d=r.signal,[2,p?v.executeQueryPBF(c,l,{type:"optimized"},{signal:d}).then(function(e){return e.data}):v.executeQuery(c,l,{signal:d}).then(function(e){return y.convertFromFeatureSet(e.data,h.service.objectIdField)})]})})},t.prototype._invalidateTile=function(e){for(var t=this._pixelBuffer,r=this._updateQueue,i=0,n=this.tileStore.intersections(e,t);i<n.length;i++){var s=n[i].tile;r.push(s.id,s.updateTimestamp)}},t.prototype._updateTile=function(e,t,r){var i=this,n=this.tileStore.get(e),s=this.queryInfo,o=s.returnCentroid,a=s.returnGeometry,u={pixelBuffer:this._pixelBuffer,returnGeometry:a,returnCentroid:o},l=g.executeTileQuery(this.queryEngine,n,u),c=l.features,p=l.objectIds,h={geometryType:this.service.geometryType,features:c,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:n.transform};return this._applyProcessing(h,r).then(function(e){var s=[],o=!0;return i._dataTileIndex.forEach(function(e){n.id!==e.id&&x.isChildOf(e,n)&&o&&!e.done&&(o=!1)}),o&&n&&n.objectIds.forEach(function(e){if(!p.has(e)){var t=i.attributeStore.getLocalId(e);s.push(t)}}),p.forEach(function(e){n.objectIds.add(e)}),n.updateTimestamp=t,i.attributeStore.sendUpdates(),i.processor.onTileData(n,{clear:!0,addOrUpdate:e.features,remove:s,transformParams:m.Utils.getTransformParams(e)},r).catch(function(e){d.isAbortError(e)||w.error("update-tile",e)})})},t.prototype._processEditsEvent=function(e,t){return o(this,void 0,void 0,function(){var r,i,o,a,u,l,c,p=this;return s(this,function(s){switch(s.label){case 0:return r=function(e){return e.objectId},i=e.addedFeatures.concat(e.updatedFeatures).map(r),o=e.deletedFeatures.map(r),a=this._createTempQueryEngine(),u=this._createObjectIdsQuery(i),i.length?[4,v.executeQuery(this.service.source,u)]:[3,2];case 1:l=s.sent().data,c=y.convertFromFeatureSet(l,this.service.objectIdField).features,this._dataTileIndex.addOrUpdateFeatures(c),a.featureStore.addMany(c),s.label=2;case 2:return this._dataTileIndex.deleteFeaturesById(o),this.attributeStore.sendUpdates(),this.tileStore.tiles.map(function(e){var r=g.executeTileQuery(a,e,n({},p.queryInfo,{pixelBuffer:p._pixelBuffer})).features,s=o.concat(i).map(function(e){return p.attributeStore.getLocalId(e)}),u={transform:e.transform,hasZ:!1,hasM:!1};return p.processor.onTileData(e,{addOrUpdate:r,remove:s,transformParams:u},{signal:t}).catch(function(e){d.isAbortError(e)||w.error("update-tile",e)})}),a.destroy(),[2]}})})},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery(this.queryInfo);return t.objectIds=e,t},i([h.property()],t.prototype,"_fetchQueue",void 0),i([h.property()],t.prototype,"_patchQueue",void 0),i([h.property()],t.prototype,"_updateQueue",void 0),i([h.property({readOnly:!0})],t.prototype,"queryEngine",void 0),i([h.property({readOnly:!0})],t.prototype,"featureStore",void 0),i([h.property({dependsOn:["viewState","_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating"]})],t.prototype,"updating",null),i([h.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],t)}(h.declared(_.default));t.default=O}.apply(null,i))||(e.exports=n)},2536:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.displayTile=null,this.tile=null,this.done=!1,this.queryInfoHash=null,this.returnExceeded=!1}return Object.defineProperty(e.prototype,"key",{get:function(){return this.tile.key},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.tile.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bounds",{get:function(){return this.tile.bounds},enumerable:!0,configurable:!0}),e}();t.default=r}.apply(null,i))||(e.exports=n)},2537:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2538),r(1695),r(1715)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var s=[],o=new Set,a=function(){function e(){this._tileById=new Map,this._tilesToFeatures=new Map,this._featureToTiles=new Map}return e.prototype.destroy=function(){this.clear()},e.prototype.add=function(e){var t=this;if(!this.has(e.id)){var i=e;this._tileById.set(i.id,i),this._tilesToFeatures.set(i,r.default.acquire()),this._tilesToFeatures.forEach(function(e,r){i!==r&&(n.isParentOf(i,r)?e.forEach(function(e){t._link(i,e)}):n.isChildOf(i,r)&&t.featureStore.forEachInBounds(i.bounds,function(r){e.has(r.objectId)&&t._link(i,r.objectId)}))})}},e.prototype.clear=function(){this._tilesToFeatures.forEach(function(e){return r.default.release(e)}),this._tilesToFeatures.clear(),this._featureToTiles.forEach(function(e){return r.default.release(e)}),this._featureToTiles.clear(),this._tileById.clear()},e.prototype.delete=function(e){var t=this,r=this.get(e.id);s.length=0,this._tilesToFeatures.get(r).forEach(function(e){var i=t._featureToTiles.get(e);i.has(r)&&1===i.size?s.push(e):t._unlink(r,e)});for(var i=0,n=s;i<n.length;i++){var o=n[i];this._unlink(r,o)}this.featureStore.removeManyById(s),this._tilesToFeatures.delete(r),this._tileById.delete(r.id),s.length=0},e.prototype.forEach=function(e,t){return this._tileById.forEach(e,t)},e.prototype.get=function(e){return this._tileById.get(e)},e.prototype.has=function(e){return this._tileById.has(e)},e.prototype.setTileFeatures=function(e,t){var i=this,n=this.get(e.id);this._tilesToFeatures.has(n)||(this._tileById.set(n.id,n),this._tilesToFeatures.set(n,r.default.acquire()));for(var a=0,u=t;a<u.length;a++){var l=u[a];o.add(l.objectId)}s.length=0,this._tilesToFeatures.get(n).forEach(function(e){if(!o.has(e)){var t=i._featureToTiles.get(e);t.has(n)&&1===t.size?s.push(e):i._unlink(n,e)}});for(var c=0,p=s;c<p.length;c++){var d=p[c];this._unlink(n,d)}this.featureStore.removeManyById(s),this.featureStore.addMany(t),o.forEach(function(e){i._link(n,e)}),o.clear(),s.length=0},e.prototype.addOrUpdateFeatures=function(e){for(var t=this,r=new Set,n=new i.default({geometryType:this.featureStore.geometryType,hasM:this.featureStore.hasM,hasZ:this.featureStore.hasZ},null),s=0,o=this.deleteFeaturesById(e.map(function(e){return e.objectId}));s<o.length;s++){var a=o[s];r.add(a)}n.addMany(e),this._tileById.forEach(function(e){n.forEachInBounds(e.bounds,function(i){t._link(e,i.objectId),r.add(e)})}),this.featureStore.addMany(e);var u=[];return r.forEach(function(e){return u.push(e)}),u},e.prototype.deleteFeaturesById=function(e){for(var t=this,i=new Set,n=this,s=0,o=e;s<o.length;s++){!function(e){var s=n._featureToTiles.get(e);s&&(s.forEach(function(r){i.add(r),t._tilesToFeatures.get(r).delete(e)}),r.default.release(s),n._featureToTiles.delete(e))}(o[s])}this.featureStore.removeManyById(e);var a=[];return i.forEach(function(e){return a.push(e)}),a},e.prototype._link=function(e,t){this._featureToTiles.get(t)||this._featureToTiles.set(t,r.default.acquire()),this._featureToTiles.get(t).add(e),this._tilesToFeatures.get(e).add(t)},e.prototype._unlink=function(e,t){this._featureToTiles.get(t).delete(e),this._tilesToFeatures.get(e).delete(t),0===this._featureToTiles.get(t).size&&(r.default.release(this._featureToTiles.get(t)),this._featureToTiles.delete(t))},e}();t.default=a}.apply(null,i))||(e.exports=n)},2538:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this._pool=[],this._set=new Set}return e.prototype.acquire=function(){if(0===this._pool.length)return new Set;var e=this._pool.pop();return this._set.delete(e),e},e.prototype.release=function(e){e&&!this._set.has(e)&&(e.clear(),this._pool.length<5e4&&(this._pool.push(e),this._set.add(e)))},e.acquire=function(){return i.acquire()},e.release=function(e){return i.release(e)},e}();t.default=r;var i=new r}.apply(null,i))||(e.exports=n)},2539:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(10),r(11),r(7),r(678)],void 0===(n=function(e,t,r,i,n,s){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){return function(e,t){this.item=e,this.promise=t,this.deferred=n.createDeferred(),this.status=0,this.value=null,this.error=null}}(),a=function(){function e(e){this._queue=[],this._queueMap=new Map,this._processor=new s.QueueProcessor(e)}return e.prototype.destroy=function(){this.clear(),this._processor.destroy()},Object.defineProperty(e.prototype,"length",{get:function(){return this._queue.length},enumerable:!0,configurable:!0}),e.prototype.abort=function(e){var t=this._queueMap.get(e);t&&(0===t.status?this._processor.abort(e):(t.status=1,t.error=n.createAbortError()))},e.prototype.clear=function(){this._queue.length=0,this._queueMap.clear(),this._processor.clear()},e.prototype.get=function(e){return i(this,void 0,void 0,function(){var t;return r(this,function(r){return[2,(t=this._queueMap.get(e))?t.promise:void 0]})})},e.prototype.isOngoing=function(e){return this._processor.isOngoing(e)},e.prototype.has=function(e){return this._queueMap.has(e)},e.prototype.pause=function(){this._processor.pause()},e.prototype.resume=function(){this._processor.resume()},e.prototype.reset=function(){this._processor.reset()},e.prototype.push=function(e){return i(this,void 0,void 0,function(){var t,i,n=this;return r(this,function(r){return t=this._processor.push(e),i=new o(e,t),this._queue.push(i),this._queueMap.set(e,i),t.then(function(e){return n._success(i,e)},function(e){return n._error(i,e)}),[2,i.deferred.promise]})})},e.prototype._success=function(e,t){e.status=2,e.value=t,this._drain()},e.prototype._error=function(e,t){e.status=1,e.error=t,this._drain()},e.prototype._drain=function(){for(;;){var e=this._queue[0];if(!e||0===e.status)return;this._queue.shift(),this._queueMap.delete(e.item),2===e.status?e.deferred.resolve(e.value):e.deferred.reject(e.error)}},e}();t.OrderedQueueProcessor=a}.apply(null,i))||(e.exports=n)}}]);