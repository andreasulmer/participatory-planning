(function(){(this||window).webpackJsonp.registerAbsMids({"esri/tasks/operations/PBFWorker":1576,"esri/tasks/operations/query":1577,"esri/tasks/operations/pbfQueryUtils":1638,"esri/tasks/operations/urlUtils":1639,"esri/tasks/operations/pbfFeatureServiceParser":1642,"esri/tasks/operations/pbfDehydratedFeatureSet":1643,"esri/tasks/operations/pbfOptimizedFeatureSet":1644,"esri/layers/graphics/data/executeTileQuery":1831,"esri/views/2d/layers/features/controllers/StreamController":2541,"esri/layers/graphics/data/StreamStore":2542,"esri/layers/graphics/sources/connections/GeoEventConnection":2543,"esri/layers/graphics/sources/connections/StreamConnection":2544,"esri/views/2d/layers/features/controllers/support/DispatchQueue":2545})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[54,81],{1576:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(3),r(97),r(7),r(407),r(405),r(40),r(633),r(1638),r.dj.m(e)],void 0===(i=function(e,t,r,n,i,o,s,a,u,c,d){Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(){}return e.prototype._parseFeatureQuery=function(e){var t=c.parsePBFFeatureQuery(e.buffer,e.options);if(e.options&&"dehydrated"===e.options.type){var r=t;if(t.spatialReference=r.spatialReference.toJSON(),r.fields)for(var n=0;n<r.fields.length;n++)r.fields[n]=r.fields[n].toJSON()}return i.resolve(t)},e}(),p=function(t){function l(){var r=t.call(this)||this;return r._thread=void 0,s.open(o.getAbsMid("./PBFWorker",e,d),{strategy:"dedicated"}).then(function(e){void 0===r._thread?r._thread=e:e.close()}),r}return r(l,t),l.prototype.destroy=function(){this._thread&&this._thread.close(),this._thread=null},l.prototype.parseFeatureQuery=function(e,t){return e&&0!==e.byteLength?this._thread?this._thread.invoke("_parseFeatureQuery",{buffer:e,options:t},{transferList:[e]}).then(function(e){if(t&&"dehydrated"===t.type){var r=e;if(r.spatialReference=a.fromJSON(r.spatialReference),r.fields)for(var i=0;i<r.fields.length;i++)r.fields[i]=u.fromJSON(r.fields[i]);for(var o=r.spatialReference,s=0,c=r.features;s<c.length;s++){var d=c[s];d.uid=n.generateUID(),d.geometry&&(d.geometry.spatialReference=o)}}return e}):i.resolve(c.parsePBFFeatureQuery(e,t)):i.resolve(null)},l}(l);t.PBFWorker=p,t.default=function(){return new l}}.apply(null,n))||(e.exports=i)},1577:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(4),r(44),r(58),r(9),r(31),r(57),r(1635),r(1638),r(1576),r(1639),r(105)],void 0===(i=function(e,t,r,n,i,o,s,a,u,c,d,l){function p(e,t){var r=e.geometry,n=e.toJSON(),i=n;if(r&&(i.geometry=JSON.stringify(r),i.geometryType=a.getJsonType(r),i.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference)),n.groupByFieldsForStatistics&&(i.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(i.objectIds=n.objectIds.join(",")),n.orderByFields&&(i.orderByFields=n.orderByFields.join(",")),!n.outFields||t&&(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)?delete i.outFields:-1!==n.outFields.indexOf("*")?i.outFields="*":i.outFields=n.outFields.join(","),n.outSR?i.outSR=n.outSR.wkid||JSON.stringify(n.outSR):r&&(n.returnGeometry||n.returnCentroid)&&(i.outSR=i.inSR),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(i.outStatistics=JSON.stringify(n.outStatistics)),n.pixelSize&&(i.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(i.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.source&&(i.layer=JSON.stringify({source:n.source}),delete n.source),n.timeExtent){var o=n.timeExtent,s=o.start,u=o.end;null==s&&null==u||(i.time=s===u?s:(null==s?"null":s)+","+(null==u?"null":u)),delete n.timeExtent}return i}function h(e,t,a,c,d){void 0===c&&(c={});var h="string"==typeof e?s.urlToObject(e):e,f=t.geometry?[t.geometry]:[];return c.responseType="pbf"===a?"array-buffer":"json",i.safeCast(u.normalizeCentralMeridian(f,null,c)).then(function(e){var i=e&&e[0];o.isSome(i)&&((t=t.clone()).geometry=i);var s=l.mapParameters(r({},h.query,{f:a},d,p(t,d)));return n(h.path+"/query",r({},c,{query:s}))})}Object.defineProperty(t,"__esModule",{value:!0});var f,y="Layer does not support extent calculation.";t.queryToQueryStringParameters=p,t.executeQuery=function(e,t,r){return h(e,t,"json",r)},t.executeQueryPBF=function(e,t,r,n){return h(e,t,"pbf",n).then(function(e){var t=function(t){var r=e;return r.data=t,r};return r.useWorker?(null==f&&(f=new d.PBFWorker),f).parseFeatureQuery(e.data,r).then(function(e){return t(e)}):t(c.parsePBFFeatureQuery(e.data,r))})},t.executeQueryForIds=function(e,t,r){return h(e,t,"json",r,{returnIdsOnly:!0})},t.executeQueryForCount=function(e,t,r){return h(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})},t.executeQueryForExtent=function(e,t,r){return h(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then(function(e){var t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(y);if(t.hasOwnProperty("count"))throw new Error(y);return e})}}.apply(null,n))||(e.exports=i)},1638:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1642)],void 0===(i=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.parsePBFFeatureQuery=function(e,t){var n=r.parseFeatureQuery(e,t).queryResult.featureResult;if(n&&n.features&&n.features.length&&n.objectIdFieldName)for(var i=n.objectIdFieldName,o=0,s=n.features;o<s.length;o++){var a=s[o];a.attributes&&(a.objectId=a.attributes[i])}return n}}.apply(null,n))||(e.exports=i)},1639:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mapParameters=function e(t){var r={};for(var n in t)if("declaredClass"!==n){var i=t[n];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){r[n]=[];for(var o=0;o<i.length;o++)r[n][o]=e(i[o])}else"object"==typeof i?i.toJSON&&(r[n]=JSON.stringify(i)):r[n]=i}return r}}.apply(null,n))||(e.exports=i)},1642:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(14),r(6),r(639),r(1643),r(1644)],void 0===(i=function(e,t,r,n,i,o,s){function a(e){return e>=I.length?null:I[e]}function u(e){return e>=T.length?null:T[e]}function c(e){return e>=C.length?null:C[e]}function d(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function l(e,t,r){for(var n=t.createPointGeometry(r);e.next();)switch(e.tag()){case 3:for(var i=e.getUInt32(),o=e.pos()+i,s=0;e.pos()<o;)t.addCoordinatePoint(n,e.getSInt64(),0,s++);break;case 1:case 2:default:e.skip()}return n}function p(e,t,r){for(var n=t.createGeometry(r),i=2+(r.hasZ?1:0)+(r.hasM?1:0);e.next();)switch(e.tag()){case 2:for(var o=e.getUInt32(),s=e.pos()+o,a=0;e.pos()<s;)t.addLength(n,e.getUInt32(),a++);break;case 3:for(var u=e.getUInt32(),c=(s=e.pos()+u,0),d=0;e.pos()<s;)t.addCoordinate(n,e.getSInt64(),d,c),++c===i&&(d++,c=0);break;case 1:default:e.skip()}return n}function h(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function f(e){for(var t={type:a(0)};e.next();)switch(e.tag()){case 1:t.name=e.getString();break;case 2:t.type=a(e.getEnum());break;case 3:t.alias=e.getString();break;case 4:t.sqlType=u(e.getEnum());break;case 5:case 6:default:e.skip()}return t}function y(e,t,r,n){for(var i=t.createFeature(r),o=0;e.next();)switch(e.tag()){case 1:var s=n[o++].name;i.attributes[s]=e.processMessage(h);break;case 2:i.geometry=e.processMessageWithArgs(p,t,r);break;case 4:i.centroid=e.processMessageWithArgs(l,t,r);break;default:e.skip()}return i}function v(e){for(var t=[0,0,0,0];e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function g(e){for(var t=[0,0,0,0];e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function _(e){for(var t={originPosition:c(0)};e.next();)switch(e.tag()){case 1:t.originPosition=c(e.getEnum());break;case 2:t.scale=e.processMessage(v);break;case 3:t.translate=e.processMessage(g);break;default:e.skip()}return t}function b(e){for(var t={};e.next();)switch(e.tag()){case 1:t.shapeAreaFieldName=e.getString();break;case 2:t.shapeLengthFieldName=e.getString();break;case 3:t.units=e.getString();break;default:e.skip()}return t}function m(e,t){for(var r=t.createSpatialReference();e.next();)switch(e.tag()){case 1:r.wkid=e.getUInt32();break;case 5:r.wkt=e.getString();break;case 2:case 3:case 4:default:e.skip()}return r}function F(e,t){var r=t.createFeatureResult();r.geometryType=d(t,0);for(var n=!1;e.next();)switch(e.tag()){case 1:r.objectIdFieldName=e.getString();break;case 3:r.globalIdFieldName=e.getString();break;case 4:r.geohashFieldName=e.getString();break;case 5:r.geometryProperties=e.processMessage(b);break;case 7:r.geometryType=d(t,e.getEnum());break;case 8:r.spatialReference=e.processMessageWithArgs(m,t);break;case 10:r.hasZ=e.getBool();break;case 11:r.hasM=e.getBool();break;case 12:r.transform=e.processMessage(_);break;case 9:var i=e.getBool();r.exceededTransferLimit=i;break;case 13:t.addField(r,e.processMessage(f));break;case 15:n||(t.prepareFeatures(r),n=!0),t.addFeature(r,e.processMessageWithArgs(y,t,r,r.fields));break;case 2:case 6:default:e.skip()}return t.finishFeatureResult(r),r}function S(e,t){for(var r={};e.next();)switch(e.tag()){case 1:r.featureResult=e.processMessageWithArgs(F,t);break;default:e.skip()}return r}function w(e){return e&&"dehydrated"===e.type?new o.Context(e):new s.Context(e)}Object.defineProperty(t,"__esModule",{value:!0});var k=n.getLogger("esri.tasks.operations.pbfFeatureServiceParser"),I=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],T=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],C=["upperLeft","lowerLeft"];t.parseFeatureQuery=function(e,t){var n=w(t);try{for(var o=new i(new Uint8Array(e),new DataView(e)),s={};o.next();)switch(o.tag()){case 2:s.queryResult=o.processMessageWithArgs(S,n);break;default:o.skip()}return s}catch(e){var a=new r("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});return k.error(a),{queryResult:{featureResult:n.createFeatureResult()}}}}}.apply(null,n))||(e.exports=i)},1643:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(97),r(24),r(40),r(103),r(633)],void 0===(i=function(e,t,r,n,i,o,s){function a(e,t,r,n){return t}function u(e,t,r,n){switch(r){case 0:return p(e,t+n,0);case 1:return h(e,t+n,1)}}function c(e,t,r,n){switch(r){case 0:return p(e,t+n,0);case 1:return h(e,t+n,1);case 2:return p(e,t,2)}}function d(e,t,r,n){switch(r){case 0:return p(e,t+n,0);case 1:return h(e,t+n,1);case 2:return p(e,t,3)}}function l(e,t,r,n){switch(r){case 0:return p(e,t+n,0);case 1:return h(e,t+n,1);case 2:case 3:return p(e,t,3)}}function p(e,t,r){var n=e.translate,i=e.scale;return n[r]+t*i[r]}function h(e,t,r){var n=e.translate,i=e.scale;return n[r]-t*i[r]}Object.defineProperty(t,"__esModule",{value:!0});var f=function(){function e(e){this.options=e,this.geometryTypes=["point","multipoint","polyline","polygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=a,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this.AttributesConstructor=function(){}}return e.prototype.createFeatureResult=function(){return new o.DehydratedFeatureSetClass},e.prototype.finishFeatureResult=function(e){this.options.applyTransform&&(e.transform=null),this.AttributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0},e.prototype.createSpatialReference=function(){return new i},e.prototype.addField=function(e,t){e.fields.push(s.fromJSON(t));var r=e.fields.map(function(e){return e.name});this.AttributesConstructor=function(){for(var e=0,t=r;e<t.length;e++)this[t[e]]=null}},e.prototype.addFeature=function(e,t){var r=this.options.maxStringAttributeLength?this.options.maxStringAttributeLength:0;if(r>0)for(var n in t.attributes){var i=t.attributes[n];"string"==typeof i&&i.length>r&&(t.attributes[n]="")}e.features.push(t)},e.prototype.prepareFeatures=function(e){switch(this.options.applyTransform&&e.transform&&(this.transform=e.transform,this.applyTransform=this.deriveApplyTransform(e)),this.vertexDimension=2,e.hasZ&&this.vertexDimension++,e.hasM&&this.vertexDimension++,e.geometryType){case"point":this.addCoordinate=this.addCoordinatePoint.bind(this),this.createGeometry=this.createPointGeometry.bind(this);break;case"polygon":this.addCoordinate=this.addCoordinatePolygon.bind(this),this.createGeometry=this.createPolygonGeometry.bind(this);break;case"polyline":this.addCoordinate=this.addCoordinatePolyline.bind(this),this.createGeometry=this.createPolylineGeometry.bind(this);break;case"multipoint":this.addCoordinate=this.addCoordinateMultipoint.bind(this),this.createGeometry=this.createMultipointGeometry.bind(this);break;default:n.neverReached(e.geometryType)}},e.prototype.createFeature=function(e){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,new o.DehydratedFeatureClass(r.generateUID(),null,new this.AttributesConstructor)},e.prototype.addLength=function(e,t,r){0===this.lengths.length&&(this.toAddInCurrentPath=t),this.lengths.push(t)},e.prototype.createPointGeometry=function(e){var t={type:"point",x:0,y:0,spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM};return t.hasZ&&(t.z=0),t.hasM&&(t.m=0),t},e.prototype.addCoordinatePoint=function(e,t,r,n){switch(t=this.applyTransform(this.transform,t,n,0),n){case 0:e.x=t;break;case 1:e.y=t;break;case 2:e.hasZ?e.z=t:e.m=t;break;case 3:e.m=t}},e.prototype.transformPathLikeValue=function(e,t){var r=0;return t<=1&&(r=this.previousCoordinate[t],this.previousCoordinate[t]+=e),this.applyTransform(this.transform,e,t,r)},e.prototype.addCoordinatePolyline=function(e,t,r,n){this.dehydratedAddPointsCoordinate(e.paths,t,r,n)},e.prototype.addCoordinatePolygon=function(e,t,r,n){this.dehydratedAddPointsCoordinate(e.rings,t,r,n)},e.prototype.addCoordinateMultipoint=function(e,t,r){0===r&&e.points.push([]);var n=this.transformPathLikeValue(t,r);e.points[e.points.length-1].push(n)},e.prototype.createPolygonGeometry=function(e){return{type:"polygon",rings:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}},e.prototype.createPolylineGeometry=function(e){return{type:"polyline",paths:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}},e.prototype.createMultipointGeometry=function(e){return{type:"multipoint",points:[],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}},e.prototype.dehydratedAddPointsCoordinate=function(e,t,r,n){if(null===this.coordinateBuffer){var i=this.lengths.reduce(function(e,t){return e+t},0);this.coordinateBuffer=new Float64Array(i*this.vertexDimension)}0===n&&0==this.toAddInCurrentPath--&&(e.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);var o=this.transformPathLikeValue(t,n),s=e[e.length-1];0===n&&s.push(new Float64Array(this.coordinateBuffer.buffer,this.coordinateBufferPtr*Float64Array.BYTES_PER_ELEMENT,this.vertexDimension)),this.coordinateBuffer[this.coordinateBufferPtr++]=o},e.prototype.deriveApplyTransform=function(e){var t=e.hasZ,r=e.hasM;return t&&r?l:t?c:r?d:u},e}();t.Context=f}.apply(null,n))||(e.exports=i)},1644:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(634),r(641),r(404)],void 0===(i=function(e,t,r,n,i){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e){this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"]}return e.prototype.createFeatureResult=function(){return new n.default},e.prototype.prepareFeatures=function(){},e.prototype.finishFeatureResult=function(){},e.prototype.addFeature=function(e,t){e.features.push(t)},e.prototype.createFeature=function(){return new r.default},e.prototype.createSpatialReference=function(){return{wkid:0}},e.prototype.createGeometry=function(){return new i.default},e.prototype.addField=function(e,t){e.fields.push(t)},e.prototype.addCoordinate=function(e,t){e.coords.push(t)},e.prototype.addCoordinatePoint=function(e,t){e.coords.push(t)},e.prototype.addLength=function(e,t){e.lengths.push(t)},e.prototype.createPointGeometry=function(){return new i.default},e}();t.Context=o}.apply(null,n))||(e.exports=i)},1831:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(4),r(10),r(11),r(33),r(90),r(1679),r(1686)],void 0===(i=function(e,t,r,n,i,o,s,a,u){function c(e,t,r,n,i,o,s,c){s&&!o?n.forEachInBounds(i,function(n){if(!t.has(n.objectId)){var i=u.getCentroid(r,n,c),o=n.attributes;i&&(t.add(n.objectId),e.push(new a.Feature(o,n.localId,null,i)))}}):o&&!s?n.forEachInBounds(i,function(n){if(!t.has(n.objectId)){var i=n.attributes,o=u.getGeometry(r,n,0,c);o&&(t.add(n.objectId),e.push(new a.Feature(i,n.localId,o,null)))}}):n.forEachInBounds(i,function(n){if(!t.has(n.objectId)){var i=n.attributes,o=u.getGeometry(r,n,0,c),s=u.getCentroid(r,n,c);o&&s&&(t.add(n.objectId),e.push(new a.Feature(i,n.localId,o,s)))}})}Object.defineProperty(t,"__esModule",{value:!0}),t.executeTileQueryForIds=function(e,t,r){var n=r.pixelBuffer*t.resolution,i=o.pad(t.bounds,n,o.create()),s=[];return e.featureStore.forEachInBounds(i,function(t){return s.push(e.featureAdapter.getObjectId(t))}),s},t.executeTileQuery=function(e,t,r){var n=r.returnGeometry,i=r.returnCentroid,a=r.pixelBuffer,u=new Set,d=[],l=a*t.resolution,p=o.pad(t.bounds,l,o.create());if(c(d,u,e,e.featureStore,p,n,i,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]}),"esriGeometryPoint"===e.geometryType||i){var h=s.getInfo(e.spatialReference);if(h){var f=h.valid,y=f[0],v=f[1];if(p[0]<y){var g=o.fromValues(v-l,p[1],v,p[3]);c(d,u,e,e.featureStore,g,n,i,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[v,t.bounds[3]]})}if(p[2]>v){var _=o.fromValues(y,p[1],y+l,p[3]);c(d,u,e,e.featureStore,_,n,i,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[y-v+t.bounds[0],t.bounds[3]]})}}}return d.sort(function(t,r){return t.attributes[e.objectIdField]-r.attributes[e.objectIdField]}),{features:d,objectIds:u}}}.apply(null,n))||(e.exports=i)},2541:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(2),r(1),r(4),r(10),r(11),r(58),r(14),r(18),r(79),r(9),r(7),r(0),r(227),r(1831),r(2542),r(2543),r(1832),r(2545)],void 0===(i=function(e,t,r,n,i,o,s,a,u,c,d,l,p,h,f,y,v,g,_,b){Object.defineProperty(t,"__esModule",{value:!0});var m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="stream",t._tileDispatchMap=new Map,t._updateIntervalId=0,t}return r(t,e),t.prototype.initialize=function(){var e=this,t=this.service,r=t.source,n=t.objectIdField,i=t.timeInfo,o=t.maximumTrackPoints,s=t.purgeOptions,a=t.serviceFilter;this.connection=new g.default(r,this.spatialReference,a),this._set("store",new v.default(n,i,this.geometryInfo,o,s)),this.connection.on("feature",function(t){return e._onFeature(t)}),this.store.events.on("update",function(t){var r=t.addOrUpdated,n=t.removed;return e._onUpdate(r,n)}),["connectionStatus","errorString"].forEach(function(t){e.watch("connection."+t,function(r){return e.remoteClient.invoke("setProperty",{propertyName:t,value:r})})}),this._updateIntervalId=setInterval(function(){return e.store.checkForUpdates()},64),this._set("queryEngine",this._createQueryEngine(this.store)),this._shouldPushDataReceived=this.service.enableDataRecieved},t.prototype.destroy=function(){clearInterval(this._updateIntervalId),this.connection.destroy(),this.queryEngine.destroy(),this._tileDispatchMap.forEach(function(e){return e.destroy()})},Object.defineProperty(t.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return s(this,void 0,void 0,function(){var r,n,i=this;return o(this,function(o){switch(o.label){case 0:return this.validateConfig(e,t),r=this.renderer.getAttributeHash(),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return o.sent(),"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,3]:(n=this.queryEngine.featureStore,[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]);case 2:o.sent(),n.forEach(function(e){return i.attributeStore.setAttributeData(e.localId,e,i.geometryInfo,i.viewParams)}),o.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return o.sent(),[4,this.attributeStore.sendUpdates()];case 5:return o.sent(),[2]}})})},t.prototype.invalidate=function(){this._repushActiveTiles()},t.prototype.onEdits=function(e){},t.prototype.queryFeatures=function(e){return a.safeCast(this.queryEngine.executeQuery(e))},t.prototype.queryFeatureCount=function(e){return a.safeCast(this.queryEngine.executeQueryForCount(e))},t.prototype.queryObjectIds=function(e){return a.safeCast(this.queryEngine.executeQueryForIds(e))},t.prototype.queryExtent=function(e){return a.safeCast(this.queryEngine.executeQueryForExtent(e))},t.prototype.queryLatestObservations=function(e){return s(this,void 0,void 0,function(){return o(this,function(t){if(!this.service.timeInfo.trackIdField)throw new u("mapview-no-trackIdField","queryLatestObservation can only be used with services that define a TrackIdField");return[2,this.queryEngine.executeQueryForLatestObservations(e)]})})},t.prototype.redraw=function(){},t.prototype.refresh=function(){},t.prototype.setViewState=function(e){var t=this,r=this.viewState&&this.viewState.scale;this.inherited(arguments),r!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(e){return t.attributeStore.setAttributeData(e.localId,e,t.geometryInfo,t.viewParams)}),this.attributeStore.sendUpdates())},t.prototype.onTileUpdate=function(e){var t=this,r=e.added;e.removed.forEach(function(e){return t._handleTileRemove(e)}),r.forEach(function(e){return t._handleTileAdd(e)})},t.prototype.enableEvent=function(e){"data-received"===e.name&&(this._shouldPushDataReceived=e.value)},t.prototype._onFeature=function(e){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}});try{var t=this.geometryInfo,r=t.geometryType,n=t.hasM,i=t.hasZ,o=f.convertFromFeature(e,r,i,n,this.store.objectIdField);this.store.add(o)}catch(e){c("esri-2d-debug")&&console.debug(e)}},t.prototype._createStoreWithFeatures=function(e){if(l.isNone(e))return null;var t=this._createFeatureStore(!1);return t.addMany(e),t},t.prototype._onUpdate=function(e,t){return s(this,void 0,void 0,function(){var r,n,i=this;return o(this,function(o){switch(o.label){case 0:return l.isSome(e)&&e.forEach(function(e){return i.onFeatureAdd(e)}),r=this._createStoreWithFeatures(e),n=this._createStoreWithFeatures(t),this.attributeStore.sendUpdates(),this.processor.supportsTileUpdates?[4,this._updateActiveTiles(r,n)]:[3,2];case 1:return o.sent(),[3,3];case 2:this._repushActiveTiles(),o.label=3;case 3:return l.isSome(t)&&t.forEach(function(e){return i.onFeatureRemove(e)}),[2]}})})},t.prototype._handleTileAdd=function(e){if(this._tileDispatchMap.has(e.id)){(t=this._tileDispatchMap.get(e.id)).up()}else{var t=new b.default;this._tileDispatchMap.set(e.id,t)}this._queryTileFeatures(e,!0,this.queryEngine)},t.prototype._handleTileRemove=function(e){this._tileDispatchMap.get(e.id).destroy(),this._tileDispatchMap.delete(e.id)},t.prototype._anyUpdatesQueued=function(){return d.valuesOfMap(this._tileDispatchMap).some(function(e){return e.hasAction()})},t.prototype._updateActiveTiles=function(e,t){return s(this,void 0,void 0,function(){var r,n,i=this;return o(this,function(o){switch(o.label){case 0:return r=l.applySome(e,function(e){return i._createQueryEngine(e)}),n=l.applySome(t,function(e){return i._createQueryEngine(e)}),[4,p.all(this.tileStore.tiles.map(function(e){return i._queryTileFeatures(e,!1,r,n)}))];case 1:return o.sent(),[2]}})})},t.prototype._repushActiveTiles=function(){for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._queryTileFeatures(r,!0,this.queryEngine)}},t.prototype._queryTileFeatures=function(e,t,r,n){return s(this,void 0,void 0,function(){var i,a,u,c,d,h,f,v,g,_,b,m,F=this;return o(this,function(S){return i={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}},a=this.queryInfo,u=a.returnCentroid,c=a.returnGeometry,d=this._pixelBuffer,h={returnCentroid:u,returnGeometry:c,pixelBuffer:d},f=this._tileDispatchMap.get(e.id),v=l.applySome(r,function(t){return y.executeTileQuery(t,e,h)}),g=l.mapOr(v,[],function(e){return e.features}),_=l.mapOr(n,[],function(t){return y.executeTileQueryForIds(t,e,h)}).map(function(e){return F.attributeStore.getLocalId(e)}),b=p.createResolver(),m=function(r){return s(F,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return[4,this.processor.onTileData(e,{addOrUpdate:g,remove:_,clear:t,transformParams:i},{signal:r})];case 1:return n.sent(),b.resolve(),[2]}})})},f.enqueue(m),[2,b.promise]})})},n([h.property()],t.prototype,"connection",void 0),n([h.property()],t.prototype,"service",void 0),n([h.property({readOnly:!0})],t.prototype,"store",void 0),n([h.property({readOnly:!0})],t.prototype,"queryEngine",void 0),n([h.property()],t.prototype,"updating",null),n([h.subclass("esri.views.2d.layers.features.controllers.StreamController")],t)}(h.declared(_.default));t.default=m}.apply(null,n))||(e.exports=i)},2542:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1),r(3),r(700),r(9),r(1695)],void 0===(i=function(e,t,r,n,i,o,s){Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_STREAM_ID_FIELD="__esri_stream_id__";var a=function(e){function r(r,n,i,s,a,u){void 0===u&&(u=128);var c=e.call(this,i)||this;return c._trackIdToObservations=new Map,c._idCounter=0,c._lastPurge=Date.now(),c._addOrUpdated=new Map,c._removed=[],c._maxAge=0,c._timeInfo=n,c._maximumTrackCount=s,c._purgeOptions=a,c.purgeInterval=u,c.objectIdField=o.unwrapOr(r,t.DEFAULT_STREAM_ID_FIELD),c._useGeneratedIds=c.objectIdField===t.DEFAULT_STREAM_ID_FIELD,c}return n(r,e),r.prototype.add=function(t){if(this._useGeneratedIds&&(t.attributes[this.objectIdField]=this._nextId(),t.objectId=t.attributes[this.objectIdField]),e.prototype.add.call(this,t),this._addOrUpdated.set(t.objectId,t),this._maxAge=Math.max(this._maxAge,t.attributes[this._timeInfo.startTimeField]),this._timeInfo.trackIdField){var r=t.attributes[this._timeInfo.trackIdField];this._trackIdToObservations.has(r)||this._trackIdToObservations.set(r,new i.default(this._maximumTrackCount));var n=this._trackIdToObservations.get(r),s=t.attributes[this.objectIdField],a=n.enqueue(s);if(o.isSome(a)){var u=this.removeById(a);o.isSome(u)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(u))}}},r.prototype.checkForUpdates=function(){var e=this._getToAdd(),t=this._getToRemove(),r=Date.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(),this._lastPurge=r),(e||t)&&this.events.emit("update",{addOrUpdated:e,removed:t})},r.prototype._getToAdd=function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach(function(r){return e[t++]=r}),this._addOrUpdated.clear(),e},r.prototype._getToRemove=function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null},r.prototype._nextId=function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e},r.prototype._purge=function(){var e=this._purgeOptions;o.isSome(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e))},r.prototype._purgeSomeByDisplayCount=function(e){var t=this;if(e.displayCount){var r=this.numFeatures;r>e.displayCount&&this._trackIdToObservations.forEach(function(n,i){if(r>e.displayCount&&n.size){var s=t.removeById(n.dequeue());o.isSome(s)&&t._removed.push(s),r--}})}},r.prototype._purgeByAge=function(e){if(e.age){var t=60*e.age*1e3,r=this._maxAge-t,n=this._timeInfo.startTimeField;this.removeIf(this._removed,function(e){return e.attributes[n]<r})}},r}(s.default);t.default=a}.apply(null,n))||(e.exports=i)},2543:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(10),r(1),r(11),r(2),r(36),r(44),r(14),r(6),r(9),r(7),r(0),r(637),r(2544),r(1577),r(402)],void 0===(i=function(e,t,r,n,i,o,s,a,u,c,d,l,p,h,f,y,v){Object.defineProperty(t,"__esModule",{value:!0});var g,_=c.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection");!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(g=t.ReadyState||(t.ReadyState={}));var b=function(e){function t(t,r,n,i,o,s){void 0===i&&(i=5),void 0===o&&(o=3);var a=e.call(this)||this;return a.errorString=null,a._source=t,a._spatialReference=r,a._filter=n,a._outFields=s,a._maxQueryDepth=i,a._maxRecordCountFactor=o,a._open(),a}return o(t,e),t.prototype._open=function(){return i(this,void 0,void 0,function(){var e,t,n,i;return r(this,function(r){switch(r.label){case 0:return[4,this._fetchServiceDefinition(this._source)];case 1:return(e=r.sent()).timeInfo.trackIdField||_.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The maximumTrackPoints property will have no effect."),[4,this._fetchWebSocketUrl(e.streamUrls,this._spatialReference)];case 2:return t=r.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return r.sent(),[4,this._tryCreateWebSocket(t)];case 4:return r.sent(),n=this._filter,i=this._outFields,this._setFilter(n,i),[2]}})})},t.prototype.destroy=function(){d.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null},Object.defineProperty(t.prototype,"connectionStatus",{get:function(){if(d.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case g.CONNECTING:case g.OPEN:return"connected";case g.CLOSING:case g.CLOSED:return"disconnected"}},enumerable:!0,configurable:!0}),t.prototype._tryCreateWebSocket=function(e,t){return void 0===t&&(t=1e3),i(this,void 0,void 0,function(){var n,i,o;return r(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,4]),n=this,[4,this._createWebSocket(e)];case 1:return n._websocket=r.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return i=r.sent(),o=t/1e3,_.error(new u("geoevent-connection","Failed to connect. Attempting to reconnect in "+o+"s",i)),[4,l.after(t)];case 3:return r.sent(),[2,this._tryCreateWebSocket(e,1.5*t)];case 4:return[2]}})})},t.prototype._createWebSocket=function(e){var t=this,r=new WebSocket(e),n=l.create(function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}});return n.then(function(){r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}}),n},t.prototype._onMessage=function(e){var t;try{t=this._enrich(JSON.parse(e.data))}catch(e){return void _.error(new u("geoevent-connection","Failed to parse message",e))}this.onFeature(t)},t.prototype._onError=function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),_.error("geoevent-connection",t)},t.prototype._onClose=function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&_.error("geoevent-connection","WebSocket closed unexpectedly with error code "+e.code),this._open()},t.prototype._fetchServiceDefinition=function(e){return i(this,void 0,void 0,function(){var t,n;return r(this,function(r){switch(r.label){case 0:return[4,a(e,{query:{f:"json"},responseType:"json"})];case 1:return t=r.sent(),n=t.data,this._serviceDefinition=n,[2,n]}})})},t.prototype._fetchWebSocketUrl=function(e,t){return i(this,void 0,void 0,function(){var n,i,o;return r(this,function(r){return n=e[0],i=n.urls,o=n.token,[2,this._inferWebSocketBaseUrl(i)+"/subscribe?outSR="+t.wkid+(o?"&token="+o:"")]})})},t.prototype._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(var t=0,r=e;t<r.length;t++){var n=r[t];if(-1!==n.indexOf("wss"))return n}return _.error(new u("geoevent-connection","Unable to infer WebSocket url",e)),null},t.prototype._setFilter=function(e,t){return i(this,void 0,void 0,function(){var n,i,o,s,a,c,p=this;return r(this,function(r){return n=this._websocket,this._filter=e,this._outFields=t,d.isNone(n)||d.isNone(e)&&d.isNone(t)?[2]:(i=JSON.stringify({filter:this._serializeFilter(e,t)}),o=!1,s=l.createResolver(),a=function(){o||(p._websocket===n&&_.error(new u("geoevent-connection","Server timed out when setting filter")),s.reject())},c=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(_.error(new u("geoevent-connection","Failed to set service filter",t.error)),p._set("errorString","Could not set service filter - "+t.error),s.reject(t.error)),n.onmessage=p._onMessage.bind(p),o=!0,s.resolve())},n.onmessage=c,n.send(i),setTimeout(a,1e4),[2,s.promise])})})},t.prototype._serializeFilter=function(e,t){var r={};if(d.isNone(e)&&d.isNone(t))return r;if(d.isSome(e)&&e.geometry)try{var n=s.fromJSON(e.geometry);if("extent"!==n.type)throw new u("Expected extent but found type "+n.type);r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(e){_.error(new u("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return d.isSome(e)&&e.where&&(r.where=e.where),d.isSome(t)&&(r.outFields=t.join(",")),r},t.prototype._enrich=function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return _.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),i=n.attributes,o=n.geometry;for(var s in i)e.attributes[s]=i[s];return o&&(e.geometry=o),e.geometry||e.centroid||_.error(new u("geoevent-connection","Found malformed feature - no geometry found",e)),e},t.prototype._queryBuddyServices=function(){return i(this,void 0,void 0,function(){var e,t,n,i,o,s,a,c,d,l;return r(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),e=this._serviceDefinition,t=e.relatedFeatures,n=e.keepLatestArchive,i=this._queryRelatedFeatures(t),o=this._queryArchive(n),[4,i];case 1:return r.sent(),[4,o];case 2:if(!(s=r.sent()))return[2];for(a=0,c=s.features;a<c.length;a++)d=c[a],this.onFeature(this._enrich(d));return[3,4];case 3:return l=r.sent(),_.error(new u("geoevent-connection","Encountered an error when querying buddy services",{error:l})),[3,4];case 4:return[2]}})})},t.prototype._queryRelatedFeatures=function(e){return i(this,void 0,void 0,function(){var t;return r(this,function(r){switch(r.label){case 0:return e?[4,this._queryBuddy(e.featuresUrl)]:[2];case 1:return t=r.sent(),this._addRelatedFeatures(t),[2]}})})},t.prototype._queryArchive=function(e){return i(this,void 0,void 0,function(){return r(this,function(t){return e?[2,this._queryBuddy(e.featuresUrl)]:[2,void 0]})})},t.prototype._queryBuddy=function(e){return i(this,void 0,void 0,function(){var t,n,i,o,s,a,u,c,l;return r(this,function(r){switch(r.label){case 0:return[4,(t=new h({url:e})).load()];case 1:return n=r.sent().capabilities,i=n.query.supportsMaxRecordCountFactor,o=n.query.supportsPagination,s=n.query.supportsCentroid,a=this._maxRecordCountFactor,u=i?t.maxRecordCount*a:t.maxRecordCount,(c=new v).outFields=d.unwrapOr(this._outFields,["*"]),c.where=d.unwrapOr(d.get(this._filter,"where"),"1=1"),c.returnGeometry=!0,c.returnExceededLimitFeatures=!0,c.outSpatialReference=this._spatialReference,s&&(c.returnCentroid=!0),i&&(c.maxRecordCountFactor=a),o?(c.num=u,t.destroy(),[2,this._queryPages(e,c)]):[4,y.executeQuery(e,c)];case 2:return l=r.sent(),t.destroy(),[2,l.data]}})})},t.prototype._queryPages=function(e,t,n,o){return void 0===n&&(n=[]),void 0===o&&(o=0),i(this,void 0,void 0,function(){var i;return r(this,function(r){switch(r.label){case 0:return t.start=o*t.num,[4,y.executeQuery(e,t)];case 1:return(i=r.sent().data).exceededTransferLimit&&o<this._maxQueryDepth?(i.features.forEach(function(e){return n.push(e)}),[2,this._queryPages(e,t,n,o+1)]):(n.forEach(function(e){return i.features.push(e)}),[2,i])}})})},t.prototype._addRelatedFeatures=function(e){for(var t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField,i=0,o=r;i<o.length;i++){var s=o[i],a=s.attributes[n];t.set(a,s)}this._relatedFeatures=t},n([p.property()],t.prototype,"connectionStatus",null),n([p.property()],t.prototype,"errorString",void 0),n([p.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],t)}(p.declared(f.default));t.default=b}.apply(null,n))||(e.exports=i)},2544:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1),r(2),r(49),r(282),r(0)],void 0===(i=function(e,t,r,n,i,o,s){Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.onFeature=function(e){this.emit("feature",e)},r([s.subclass("esri.layers.graphics.sources.connections.StreamConnection")],t)}(s.declared(i.EventedMixin(o.HandleOwner)));t.default=a}.apply(null,n))||(e.exports=i)},2545:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(10),r(11),r(7)],void 0===(i=function(e,t,r,n,i){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){this._action=null,this._queue=[],this._abortController=i.createAbortController(),this._refs=1}return e.prototype.up=function(){this._refs++},e.prototype.down=function(){return 0==--this._refs},e.prototype.clear=function(){this._abortController.abort(),this._abortController=i.createAbortController()},e.prototype.destroy=function(){this._queue.length=0,this._action&&(this._action=null)},e.prototype.enqueue=function(e){this._action?this._queue.push(e):this._setAction(e)},e.prototype.flush=function(){return n(this,void 0,void 0,function(){var e,t,n;return r(this,function(r){return(e=this._action)?(t=this._abortController.signal,n=this._queue.reduce(function(e,r){return e.then(function(){return r(t)})},e),this._action=n.then(this._handleNext.bind(this)),this._queue.length=0,[2,n]):[2]})})},e.prototype.hasAction=function(){return!!this._action},e.prototype._setAction=function(e){var t=this._abortController.signal;this._action=e(t).then(this._handleNext.bind(this))},e.prototype._handleNext=function(){this._queue.length?this._setAction(this._queue.shift()):this._action=null},e}();t.default=o}.apply(null,n))||(e.exports=i)}}]);